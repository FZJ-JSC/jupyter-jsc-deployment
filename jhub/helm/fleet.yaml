defaultNamespace: jupyterjsc
helm:
  releaseName: jupyterhub
  repo: https://jupyterhub.github.io/helm-chart/
  chart: jupyterhub
  values:
  valuesFiles:
    - values/hub/config.yaml
    - values/hub/extraConfig.yaml
    - values/hub/extraContainers.yaml
    - values/hub/extraEnv.yaml
    - values/hub/extraVolumeMounts.yaml
    - values/hub/image.yaml
    - values/hub/initContainers.yaml
    - values/hub/others.yaml
    - values/common.yaml
    - values/proxy.yaml
targetCustomizations:
  - name: staging
    clusterSelector:
      matchLabels:
        stage: staging
    helm:
      values:
        hub:
          extraEnv:
            - name: JUPYTERHUB_STAGE
              value: "staging"
            - name: JUPYTERHUB_VERSION
              value: "2.1.1"
            - name: LOGGING_CONFIG_FILE
              value: "/mnt/shared-data/git_config/logging.json"
            - name: MAINTENANCE_PATH
              value: "/mnt/shared-data/maintenance-check"
            - name: MAINTENANCE_FILE
              value: "/mnt/shared-data/maintenance-check/maintenance.json"
            - name: RESERVATIONS_FILE
              value: "/mnt/shared-data/reservation-check/reservation_test.json"
            - name: TUNNEL_DEPLOYMENT_NAMESPACE
              value: "jupyterjsc"
            - name: TUNNEL_JUPYTERHUB_USER_PASS
              valueFrom:
                secretKeyRef:
                  name: drf-tunnel-passwds
                  key: JUPYTERHUB_USER_PASS
            - name: UNICOREMGR_JUPYTERHUB_USER_PASS
              valueFrom:
                secretKeyRef:
                  name: drf-unicoremgr-passwds
                  key: JUPYTERHUB_USER_PASS
            - name: K8SMGRHDFCLOUD_JUPYTERHUB_USER_PASS
              valueFrom:
                secretKeyRef:
                  name: drf-k8smgr-passwds
                  key: JUPYTERHUB_USER_PASS
            - name: OAUTH_CLIENT_ID
              valueFrom:
                secretKeyRef:
                  name: hub-custom
                  key: oauth_client_id_password
            - name: OAUTH_CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  name: hub-custom
                  key: oauth_client_secret_password
            - name: SQL_HOST
              valueFrom:
                secretKeyRef:
                  name: postgresql-general
                  key: SQL_HOST
            - name: SQL_PORT
              valueFrom:
                secretKeyRef:
                  name: postgresql-general
                  key: SQL_PORT
            - name: SQL_DATABASE
              valueFrom:
                secretKeyRef:
                  name: postgresql-users-jupyterjsc
                  key: JUPYTERHUB_DATABASE
            - name: SQL_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgresql-users-jupyterjsc
                  key: JUPYTERHUB_PASSWORD
            - name: SQL_USER
              valueFrom:
                secretKeyRef:
                  name: postgresql-users-jupyterjsc
                  key: JUPYTERHUB_USER
            - name: DEPLOYMENT_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
          extraVolumes:
            - name: shared-data
              emptyDir: {}
            - name: persistent
              nfs:
                path: /mnt/storage/jupyterhub
                server: 10.0.94.174
            - name: mount-watch
              configMap:
                defaultMode: 400
                name: jupyterhub-mw
            - name: cleanup-sql
              configMap:
                defaultMode: 400
                name: jupyterhub-cleanup-sql
            - name: maintenance-check
              configMap:
                defaultMode: 400
                name: jupyterhub-maintenance-check
            - name: reservation-check
              configMap:
                defaultMode: 400
                name: jupyterhub-reservation-check
            - name: internal-ssl
              secret:
                secretName: internal-ssl
            - name: reservation-keypair
              secret:
                secretName: reservation-keypair
            - name: drf-tunnel-certs
              secret:
                secretName: drf-tunnel-certs
                items:
                  - key: tls.ca
                    path: ca.pem
            - name: drf-unicoremgr-certs
              secret:
                secretName: drf-unicoremgr-certs
                items:
                  - key: tls.ca
                    path: ca.pem
            - name: drf-k8smgr-certs
              secret:
                secretName: drf-k8smgr-certs
                items:
                  - key: tls.ca
                    path: ca.pem
            - name: unity-jsc-certs
              secret:
                secretName: unity-jsc-certs
            - name: hub-nginx-config
              configMap:
                defaultMode: 400
                name: hub-nginx-config
          labels:
            stage: staging
          livenessProbe:
            enabled: False
          readinessProbe:
            enabled: False
          command: ["/bin/bash"]
          args:
            - -c
            - >-
              /bin/bash /src/entrypoint.sh -f /usr/local/etc/jupyterhub/jupyterhub_config.py
              # while true; do sleep 30; done
          containerSecurityContext:
            runAsUser: 0
            runAsGroup: 0
            allowPrivilegeEscalation: true
          extraConfig:
            stagingConfig: |-
              c.JupyterHub.trusted_alt_names = [
                "DNS:hub",
                "DNS:proxy-public",
                "DNS:jupyter-jsc-staging.fz-juelich.de",
                "DNS:drf-k8smgr-jupyterhub-forward.jupyterjsc.svc",
                "DNS:drf-k8smgr-jupyterhub-forward.userlabs.svc",
                "DNS:jrlogin01i",
                "DNS:jrlogin02i",
                "DNS:jrlogin03i",
                "DNS:jrlogin04i",
                "DNS:jrlogin05i",
                "DNS:jrlogin06i",
                "DNS:jrlogin07i",
                "DNS:jrlogin08i",
                "DNS:jrlogin09i",
                "DNS:jrlogin10i",
                "DNS:jrlogin11i",
                "DNS:jrlogin12i",
                "DNS:jrlogin13i",
                "DNS:jrlogin14i",
                "DNS:jwlogin00i",
                "DNS:jwlogin01i",
                "DNS:jwlogin02i",
                "DNS:jwlogin03i",
                "DNS:jwlogin04i",
                "DNS:jwlogin05i",
                "DNS:jwlogin06i",
                "DNS:jwlogin07i",
                "DNS:jwlogin08i",
                "DNS:jwlogin09i",
                "DNS:jwlogin10i",
                "DNS:jwlogin11i",
                "DNS:jwvis00i",
                "DNS:jwvis01i",
                "DNS:jwvis02i",
                "DNS:jwvis03i",
                "DNS:jwlogin21i",
                "DNS:jwlogin22i",
                "DNS:jwlogin23i",
                "DNS:jwlogin24i",
                "DNS:hdfmll01i",
                "DNS:hdfmll02i",
                "DNS:deepv",
                "DNS:jsfl01i",
                "DNS:jsfl02i",
                "DNS:jsfl03i",
                "DNS:jsfl04i",
              ]
              c.CustomGenericOAuthenticator.oauth_callback_url = (
                  "https://jupyter-jsc-staging.fz-juelich.de/hub/oauth_callback"
              )
